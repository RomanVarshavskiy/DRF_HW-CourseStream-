# CourseStream API

CourseStream — это backend-приложение на Django REST Framework (DRF) для управления онлайн-курсами, уроками и подписками с интеграцией платежной системы Stripe и фоновыми задачами через Celery.

## Основной функционал

- **Управление обучением**: CRUD для курсов и уроков.
- **Подписки**: Возможность пользователей подписываться на обновления курсов.
- **Платежи**: Интеграция со Stripe для оплаты доступа к материалам (поддержка курсов и отдельных уроков).
- **Профили пользователей**: Кастомная модель пользователя (авторизация по email), личный кабинет с историей платежей.
- **Права доступа**: Гибкая система разрешений (Владелец, Модератор, Публичный доступ).
- **Уведомления**: Отправка уведомлений об обновлении контента в Telegram и на Email.
- **Автоматизация**: Фоновые задачи (Celery) для очистки неактивных пользователей и рассылки уведомлений.
- **Документация**: Автоматическая генерация документации API через Swagger/Redoc.

## Технологический стек

- **Python 3.13**
- **Django / DRF**
- **PostgreSQL** (База данных)
- **Redis** (Брокер для Celery)
- **Celery / Celery Beat** (Фоновые и периодические задачи)
- **Stripe API** (Оплата)
- **Poetry** (Управление зависимостями)
- **Docker** (Опционально для развертывания)

## Установка и запуск

### Предварительные требования
Убедитесь, что у вас установлены:
- Python 3.13+
- Poetry
- Redis (для работы Celery)

### Шаги установки

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <url_вашего_репозитория>
    cd DRF_HW
    ```

2.  **Установите зависимости:**
    ```bash
    poetry install
    ```

3.  **Настройте переменные окружения:**
    Создайте файл `.env` на основе `.env_template` и заполните необходимые данные:
    - Настройки БД (POSTGRES_*)
    - Stripe API ключи
    - Настройки Email/Telegram бота
    - CELERY_BROKER_URL

4.  **Примените миграции:**
    ```bash
    poetry run python manage.py migrate
    ```

5.  **Создайте суперпользователя (админа):**
    ```bash
    poetry run python manage.py csu
    ```
    *По умолчанию создается: admin@example.com / 1234admin*

6.  **Запустите сервер:**
    ```bash
    poetry run python manage.py runserver
    ```
    

    ## Запуск через Docker Compose

    Если у вас установлен Docker и Docker Compose, вы можете запустить весь проект (Django, PostgreSQL, Redis, Celery) одной командой.

    ### Шаги для запуска:

    1.  **Настройте переменные окружения:**
        Убедитесь, что у вас создан файл `.env`. Для работы в Docker убедитесь, что `POSTGRES_HOST` установлен как `db`, а `CELERY_BROKER_URL` использует `redis` в качестве хоста.

    2.  **Соберите и запустите контейнеры:**
        ```bash
        docker-compose up --build
        ```

    ### Проверка работоспособности сервисов:

    - **Django (web)**: Откройте в браузере [http://127.0.0.1:8000/](http://127.0.0.1:8000/). Если сервер работает, вы увидите страницу приветствия или документацию.
    - **PostgreSQL (db)**: Проверьте логи контейнера (`docker-compose logs db`). Должно быть сообщение о готовности принимать подключения. Также можно выполнить:
      ```bash
      docker-compose exec db pg_isready -U <ваш_postgres_user>
      ```
    - **Redis**: Выполните команду ping:
      ```bash
      docker-compose exec redis redis-cli ping
      ```
      В ответе должно прийти `PONG`.
    - **Celery Worker**: Проверьте логи: `docker-compose logs celery`. Вы должны увидеть сообщение о готовности (ready) и список подключенных задач.
    - **Celery Beat**: Проверьте логи: `docker-compose logs celery-beat`. В логах должны появляться записи о планировании задач.


### Запуск фоновых задач (Celery)

В отдельных терминалах запустите воркер и планировщик:
Worker
poetry run celery -A config worker -l info
Beat (периодические задачи)
poetry run celery -A config beat -l info

## Документация API

После запуска сервера документация доступна по адресам:
- **Swagger UI**: [http://127.0.0.1:8000/swagger/](http://127.0.0.1:8000/swagger/)
- **ReDoc**: [http://127.0.0.1:8000/redoc/](http://127.0.0.1:8000/redoc/)

## Тестирование

Для запуска тестов и проверки покрытия кода:
poetry run coverage run --source='.' manage.py test poetry run coverage report

## Права доступа (Permissions)
- **Модераторы**: Могут просматривать и редактировать любые курсы/уроки, но не могут их создавать или удалять.
- **Владельцы**: Полный доступ (CRUD) к своим объектам.
- **Обычные пользователи**: Просмотр доступен только после авторизации. Профиль другого пользователя отображается в сокращенном виде.

## Автоматические задачи
- **deactivate_inactive_users**: Каждый день в 03:00 деактивирует пользователей, которые не заходили в систему более 30 дней.
- **four_hours_notification**: Раз в 30 минут проверяет обновления курсов и рассылает уведомления подписчикам (не чаще чем раз в 4 часа для одного курса).

## Деплой и CI/CD

В проекте настроена автоматизация через GitHub Actions. При каждом пуше в ветку `main` запускается процесс проверки кода, тестирования и автоматического деплоя на удаленный сервер.

### Настройка удаленного сервера (Ubuntu/Debian)

1.  **Установите Docker и Docker Compose:**
    ```bash
    sudo apt update
    sudo apt install docker.io docker-compose -y
    sudo systemctl enable --now docker
    ```
2.  **Подготовьте директорию проекта:**
    Создайте папку, указанную в `DEPLOY_DIR` (например, `/home/username/coursestream`), и разместите там файлы `docker-compose.yml` и конфигурацию `nginx/nginx.conf`.
3.  **Настройте `.env` на сервере:**
    Создайте файл `.env` в директории проекта на сервере и заполните его боевыми значениями.

### Настройка GitHub Secrets

Для корректной работы GitHub Actions (workflow) необходимо добавить следующие секреты в настройках вашего репозитория (**Settings -> Secrets and variables -> Actions**):

| Секрет | Описание |
| :--- | :--- |
| `SECRET_KEY` | Секретный ключ Django |
| `DOCKER_HUB_USERNAME` | Ваш логин на Docker Hub |
| `DOCKER_HUB_ACCESS_TOKEN` | Access Token от Docker Hub |
| `SSH_KEY` | Приватный SSH-ключ для доступа к серверу |
| `SSH_USER` | Имя пользователя на сервере (например, `root`) |
| `SERVER_IP` | IP-адрес вашего сервера |
| `DEPLOY_DIR` | Путь к папке проекта на сервере (например, `/home/app/coursestream`) |

### Workflow шаги

1.  **Lint**: Проверка кода на соответствие стандартам (flake8).
2.  **Test**: Запуск тестов внутри временного контейнера с PostgreSQL.
3.  **Build**: Сборка Docker-образа и отправка его на Docker Hub с тегами `latest` и SHA коммита.
4.  **Deploy**: Подключение к серверу по SSH, загрузка новых образов (`docker compose pull`) и перезапуск контейнеров.

### Ручной деплой
Если вам нужно обновить приложение вручную на сервере:
```bash
docker compose pull
docker compose up -d --remove-orphans

